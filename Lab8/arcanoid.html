<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.5, maximum-scale=0.5">
    <title>Task 1</title>
    <canvas id="myCanvas" width="800" height="600" style="border:1px solid #d3d3d3;">
        Your browser does not support the HTML canvas tag.</canvas>
</head>

<body style="width: 100%;">
    <pre class="output"></pre>
    <script>
        let canvas, context;
        let key;
        let lastPress = 0;
        let score = 0;
        let isDriving = false;

        // spawn locations
        let maxX = 465;
        let maxY = -25;
        let minX = 200;
        let minY = -100;

        class Ball {
            constructor() {
                this.radius = 12;
                this.x = 400;
                this.y = 550;
                this.color = 'green';
                this.dx = 0;
                this.dy = 0;
            }

            drawBall() {
                context.beginPath();
                context.arc(this.x, this.y, this.radius, 0, 2 * Math.PI, false);
                context.fillStyle = this.color;
                context.fill();
                this.x += this.dx;
                this.y += this.dy;
            }
        }

        class Block {
            constructor(x, y, color) {
                this.height = 25;
                this.width = 70;
                this.x = x;
                this.y = y;
                this.color = color;
            }

            drawBlock() {
                context.beginPath();
                context.fillStyle = this.color;
                context.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        class Platform {
            constructor() {
                this.height = 25;
                this.width = 100;
                this.x = 350;
                this.y = 570;
                this.color = 'black';
            }

            drawPlatform() {
                context.beginPath();
                context.fillStyle = this.color;
                context.fillRect(this.x, this.y, this.width, this.height);
            }
        }

        function initBlocks() {
            let tempI = [];
            let tempJ = [];
            let x = 25;
            let y = 100;
            let colors = ['red', 'orange', 'yellow'];

            for (let i = 0; i < 3; i++) {
                for (let j = 0; j < 10; j++) {
                    tempJ.push(new Block(x, y, colors[i]));
                    x += 75;
                }
                x = 25;
                y += 50;
                tempI.push(tempJ);
            }

            return tempI;
        }

        // Game objects
        let platform = new Platform();
        let ball = new Ball();
        let blocks = initBlocks();

        window.onload = init;

        var keyPressed = {};
        document.addEventListener('keydown', function (e) {
            keyPressed[e.keyCode] = true;

            if (keyPressed.Shift1 == true && keyPressed.Control1 == true) {
                // Left shift+CONTROL pressed!
                keyPressed = {}; // reset key map
            }
            if (keyPressed.Shift2 == true && keyPressed.Control2 == true) {
                // Right shift+CONTROL pressed!
                keyPressed = {};
            }

        }, false);

        document.addEventListener('keyup', function (e) {
            keyPressed[e.keyCode] = false;
            // keyPressed = {};
        }, false);

        function init() {
            canvas = document.querySelector('#myCanvas');
            context = canvas.getContext('2d');

            requestAnimationFrame(animate);
        }

        function drawBlocks() {
            for (let i = 0; i < blocks.length; i++) {
                blocks[i].forEach(block => {
                    block.drawBlock();

                });
            }
        }

        function drawScore() {
            context.beginPath();
            context.font = "30px Arial";
            context.fillStyle = 'black';
            context.fillText("Score " + score, 10, 30);
        }

        function drawGameOver() {
            context.beginPath();
            context.font = "30px Arial";
            context.fillStyle = 'black';
            context.fillText("GAME OVER ", 325, 100);
        }

        function handleMovement() {
            if (keyPressed[37]) {
                if (car.x > 160 && roadSpeed > 0) {
                    car.move(-5);
                }
            }

            if (keyPressed[39]) {
                if (car.x < 590 && roadSpeed > 0) {
                    car.move(5);
                }
            }
        }

        let output = document.querySelector('.output');

        function onClick() {
            // feature detect
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation, true);
                        }
                    })
                    .catch(console.error);
            } else {
                // Accelerometer
                window.addEventListener("deviceorientation", handleOrientation, true);
            }

            ball.dx = 2;
            ball.dy = 2;
        }

        function handleOrientation(event) {
            var gamma = event.gamma;
            console.log(gamma);

            if (gamma > 0 && car.x < 590) {
                car.move(5);
            }

            if (gamma < 0 && car.x > 160) {
                car.move(-5);
            }

            output.innerHTML = "gamma: " + gamma + "\n";
        }

        function moveLeft() {
            if (car.x > 160) {
                speedX -= 5;
            }
        }

        function moveRight() {
            if (car.x < 590) {
                speedX += 5;
            }
        }

        function moveUp() {
            if (roadSpeed <= 10) {
                roadSpeed += 1;
                isDriving = true;
            }
        }

        function moveDown() {
            if (roadSpeed > 0) {
                roadSpeed -= 1;
                isDriving = false;
            }
        }

        function stopMove() {
            speedX = 0;
            acc = false;
            isDriving = false;
        }

        function updatePosition() {
            if (car.x > 160 && car.x < 590) {
                car.move(speedX);
            } else if (car.x == 590 && speedX < 0) {
                car.move(speedX);
            } else if (car.x == 160 && speedX > 0) {
                car.move(speedX);
            }

            if (keyPressed[38]) {
                if (roadSpeed <= 10) {
                    roadSpeed += 0.1;
                    isDriving = true;
                }
            } else if (keyPressed[40]) {
                if (roadSpeed > 0) {
                    roadSpeed -= 0.1;
                    isDriving = false;
                }
            }
        }

        function stripAnimation() {
            firstStrip += Math.round(roadSpeed);
            stripes.forEach(strip => {
                strip.y += Math.round(roadSpeed);
                if (firstStrip >= secondStrip) {
                    stripes = [new Strip(-100), new Strip(0), new Strip(100), new Strip(200), new Strip(300), new Strip(400), new Strip(500)];
                    firstStrip = -100;
                }
            });
        }

        function sideAnimation() {
            firstSideStrip += Math.round(roadSpeed);
            leftSideStripes.forEach(leftSideStrip => {
                leftSideStrip.y += Math.round(roadSpeed);
            });

            rightSideStripes.forEach(rightSideStrip => {
                rightSideStrip.y += Math.round(roadSpeed);
            });

            if (firstSideStrip >= secondSideStrip) {
                initSideStripes();
                firstSideStrip = -100;
            }
        }

        function roadObjectsAnimation() {
            obstacles.forEach((obstacle, index, object) => {
                if (obstacle.y > 625) {
                    object.splice(index, 1);
                } else {
                    obstacle.y += Math.round(roadSpeed);
                }
            });

            points.forEach((point, index, object) => {
                if (point.y > 625) {
                    object.splice(index, 1);
                } else {
                    point.y += Math.round(roadSpeed);
                }
            });
        }

        function blocksCollisionCheck() {
            // circle - rectangle
            blocks.forEach((block, blockIndex, blocksObject) => {
                let dx = Math.abs(ball.x - (block.x + block.width / 2));
                let dy = Math.abs(ball.y - (block.y + block.height / 2));

                if (dx > (ball.radius + block.width / 2) ||
                    dy > (ball.radius + block.height / 2)) {
                    return;
                } else {
                    blocksObject.splice(blockIndex, 1);
                    score += 1;
                    ball.dy *= -1;
                }
            });
        }

        function platformCollisionCheck() {
            let dx = Math.abs(ball.x - (platform.x + platform.width / 2));
            let dy = Math.abs(ball.y - (platform.y + platform.height / 2));

            if (dx > (ball.radius + platform.width / 2) ||
                dy > (ball.radius + platform.height / 2)) {
                return;
            } else {
                ball.dy *= -1;
            }
        }

        function canvasCollisionCheck() {
            if (ball.x + ball.dx > canvas.width - ball.radius || ball.x + ball.dx < ball.radius) {
                ball.dx *= -1;
            }

            if (ball.y + ball.dy > canvas.height - ball.radius || ball.y + ball.dy < ball.radius) {
                ball.dy *= -1;
            }
        }

        function animate() {
            context.clearRect(0, 0, 800, 600);

            drawScore();
            platform.drawPlatform();
            ball.drawBall();
            drawBlocks();

            blocksCollisionCheck();
            platformCollisionCheck();
            canvasCollisionCheck();

            requestAnimationFrame(animate);
        }
    </script>
    <br>
    <br>
    <div style="display: flex;">
        <div style="display: flex; flex-direction: column; justify-content: center; width: 50%;">
            <button onClick="moveUp()"
                style="width: 100%; height: 100px; display: inline-block; background-color: rgb(36, 35, 35); color: white;">LEFT</button>
        </div>
        <div style="display: flex; flex-direction: column; justify-content: center; width: 50%;">
            <button onmousedown="moveDown()"
                style="width: 100%; height: 100px; background-color: rgb(36, 35, 35); color: white;">RIGHT</button>
        </div>
    </div>

    <button onmousedown="onClick()"
        style="width: 100%; height: 100px; background-color: rgb(36, 35, 35); color: white;">START GAME</button>
</body>

</html>